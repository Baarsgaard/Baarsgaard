#!/usr/bin/bash

add_prefix="echo '{}' | awk -v pre='$(git rev-parse --show-toplevel)/' '{print pre\$2}' | xargs"
file_path='$(echo "{}" | awk -v pre="$(git rev-parse --show-toplevel)/" "{print pre$2}")'

preview="$add_prefix git diff --color=always"
if [[ $* == *-a* ]]; then
  preview="$add_prefix batcat --color=always --style=changes,numbers"
fi

changefinder="git -c color.ui=always status -sb"
reloader="+reload($changefinder)"

bash -c "$changefinder" | fzf -m \
    --header 'keybinds (ctrl+): a, u, p, c, e, s.' \
    --header-lines 1 \
    --bind "ctrl-e:execute-silent($add_prefix code)" \
    --bind='ctrl-s:toggle-preview' \
    --bind "ctrl-a:execute-silent($add_prefix git add)$reloader" \
    --bind "ctrl-p:execute(git add --patch $file_path)$reloader" \
    --bind "ctrl-c:execute(git commit)$reloader" \
    --bind "ctrl-r:execute-silent($add_prefix git restore)$reloader" \
    --bind "ctrl-u:execute-silent($add_prefix git restore --staged)$reloader" \
    --bind "ctrl-l:preview(git log --oneline --decorate --graph --max-count=$FZF_PREVIEW_LINES)" \
    --preview-window 'wrap' \
    --preview "$preview"
